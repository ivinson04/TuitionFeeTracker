<!DOCTYPE html>
<html>
<head>
  <title>Learning Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .mic-button {
      background-color: #4CAF50;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      margin-top: 10px;
      font-size: 16px;
      display: inline-block !important;
      visibility: visible !important;
      z-index: 1000;
    }
    .mic-button.recording {
      background-color: #ff4444;
    }
    .mic-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .mic-container {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .mic-status {
      color: red;
      margin-left: 10px;
      font-size: 14px;
    }
    .test-content {
      white-space: pre-wrap; /* Preserve line breaks and spaces */
      font-family: monospace; /* Improve readability */
      font-size: 16px;
      line-height: 1.5;
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    @media screen and (max-width: 768px) {
      .mic-button {
        margin-top: 10px;
        width: auto;
        min-width: 140px;
        font-size: 14px;
      }
      .mic-container {
        flex-direction: column;
        align-items: flex-start;
      }
      .test-content {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="{{ url_for('student_dashboard') }}">Dashboard</a></li>
        <li><a href="{{ url_for('video_lectures') }}">Video Lectures</a></li>
        <li><a href="{{ url_for('student_tests') }}">Tests</a></li>
        <li><a href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>{{ test.title }}</h1>

    {% if test.is_timed %}
    <p>Time Remaining: <span id="time-remaining">--:--:--</span></p>
    {% endif %}

    <section>
      <h2>Test Instructions</h2>
      <div class="card">
        <p><strong>Description:</strong> {{ test.description }}</p>
        <p><strong>Type:</strong> {{ 'Timed' if test.is_timed else 'Untimed' }}</p>
        {% if test.is_timed %}
        <p><strong>Time Limit:</strong> {{ test.time_limit }} minutes</p>
        {% endif %}
        <ul>
          <li>Read all questions carefully before answering.</li>
          <li>Type or speak your answers in the text area provided below.</li>
          {% if test.is_timed %}
          <li>The test will automatically submit when the time runs out.</li>
          <li>Do not leave or refresh the page during the test.</li>
          <li>Your work is automatically saved every 30 seconds.</li>
          {% endif %}
        </ul>
      </div>
    </section>

    <section>
      <h2>Test Questions</h2>
      <div class="card">
        {% if test_content %}
        <div class="test-content">{{ test_content | safe }}</div>
        {% else %}
        <p>No test content available. Please contact your instructor.</p>
        {% endif %}
      </div>
    </section>

    <section>
      <h2>Your Response</h2>
      <div class="card">
        <form method="POST" action="{{ url_for('submit_test', assignment_id=assignment.id) }}">
          <label for="content">Your Answer:</label><br>
          <textarea name="content" id="content" rows="10" cols="100">{{ response.content if response and response.content else '' }}</textarea>
          <div class="mic-container">
            <button type="button" id="micButton" class="mic-button">üéôÔ∏è Start Recording</button>
            <span id="micStatus" class="mic-status"></span>
          </div>
          <input type="submit" name="submit_button" value="Submit Test">
          <input type="submit" name="submit_button" value="Save and Exit">
        </form>
      </div>
    </section>
  </main>

  <script>
    // Timer script for timed tests
    {% if test.is_timed and time_remaining %}
    let timeRemaining = {{ time_remaining }};
    const timeDisplay = document.getElementById('time-remaining');
    function updateTimer() {
      if (timeRemaining <= 0) {
        document.forms[0].submit();
        return;
      }
      let hours = Math.floor(timeRemaining / 3600);
      let minutes = Math.floor((timeRemaining % 3600) / 60);
      let seconds = timeRemaining % 60;
      timeDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      timeRemaining--;
    }
    setInterval(updateTimer, 1000);
    {% endif %}

    // Autosave script
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('content');
      let lastContent = textarea.value;
      setInterval(function() {
        if (textarea.value !== lastContent) {
          lastContent = textarea.value;
          fetch('{{ url_for('submit_test', assignment_id=assignment.id) }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `response_content=${encodeURIComponent(textarea.value)}&autosave=true`
          }).then(response => response.json()).then(data => {
            console.log(data.message);
          });
        }
      }, 30000);
    });

    // Speech-to-text script
    const micButton = document.getElementById('micButton');
    const answerTextarea = document.getElementById('content');
    const micStatus = document.getElementById('micStatus');

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US'; // Adjust as needed (e.g., 'hi-IN' for Hindi)
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onresult = function(event) {
        if (event.results.length > 0) {
          const transcript = event.results[0][0].transcript;
          answerTextarea.value = answerTextarea.value + (answerTextarea.value ? ' ' : '') + transcript;
          micStatus.textContent = 'Transcription added';
        }
      };

      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        micButton.textContent = 'üéôÔ∏è Start Recording';
        micButton.classList.remove('recording');
        micStatus.textContent = 'Error: ' + event.error;
      };

      recognition.onend = function() {
        micButton.textContent = 'üéôÔ∏è Start Recording';
        micButton.classList.remove('recording');
        micStatus.textContent = '';
      };

      micButton.onclick = function() {
        if (!micButton.classList.contains('recording')) {
          try {
            recognition.start();
            micButton.textContent = 'üéôÔ∏è Stop Recording';
            micButton.classList.add('recording');
            micStatus.textContent = 'Recording...';
          } catch (e) {
            micStatus.textContent = 'Error starting mic: ' + e.message;
          }
        } else {
          recognition.stop();
        }
      };

      // Log browser support
      micStatus.textContent = 'Speech recognition supported';
    } else {
      micButton.disabled = true;
      micButton.textContent = 'üéôÔ∏è Mic Not Supported';
      micStatus.textContent = 'Speech recognition not supported in this browser';
    }
  </script>
</body>
</html>