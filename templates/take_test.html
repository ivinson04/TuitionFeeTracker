<!DOCTYPE html>
<html>
<head>
  <title>Learning Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Dark mode JavaScript -->
<script src="{{ url_for('static', filename='darkmode.js') }}"></script>
  <style>
    .mic-button {
      background-color: #4CAF50;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      margin-top: 10px;
      font-size: 16px;
      display: inline-block !important;
      visibility: visible !important;
      z-index: 1000;
    }
    .mic-button.recording {
      background-color: #ff4444;
    }
    .mic-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .mic-container {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 20px;
      margin-bottom: 30px;
      padding: 10px;
      border-top: 1px solid #eee;
    }
    .mic-status {
      color: red;
      margin-left: 10px;
      font-size: 14px;
    }
    .test-content {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 16px;
      line-height: 1.5;
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .submission-controls {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .submit-button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .save-button {
      background-color: #6c757d;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Enhanced Modal styles for mobile optimization */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 25px;
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
      animation: modalSlideIn 0.3s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-60%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    }
    
    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
    }
    
    .modal-content p {
      margin-bottom: 25px;
      color: #666;
      font-size: 16px;
      line-height: 1.4;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .modal-confirm {
      background-color: #dc3545;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 140px;
    }
    
    .modal-confirm:hover {
      background-color: #c82333;
      transform: translateY(-1px);
    }
    
    .modal-cancel {
      background-color: #6c757d;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 140px;
    }
    
    .modal-cancel:hover {
      background-color: #5a6268;
      transform: translateY(-1px);
    }

    /* Desktop styles */
    @media screen and (min-width: 769px) {
      .modal-content {
        width: 90%;
        max-width: 500px;
        padding: 30px;
      }
      
      .modal-buttons {
        flex-direction: row;
      }
    }

    /* Mobile and tablet styles */
    @media screen and (max-width: 768px) {
      .modal {
        padding: 15px;
      }
      
      .modal-content {
        width: 95%;
        max-width: none;
        padding: 20px;
        margin: 0;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-height: auto;
      }
      
      .modal-content h3 {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      .modal-content p {
        font-size: 15px;
        margin-bottom: 20px;
      }
      
      .modal-buttons {
        flex-direction: column;
        gap: 12px;
      }
      
      .modal-confirm,
      .modal-cancel {
        width: 100%;
        padding: 14px 20px;
        min-width: auto;
        font-size: 16px;
      }
      
      .mic-button {
        margin-top: 10px;
        width: auto;
        min-width: 140px;
        font-size: 14px;
      }
      
      .mic-container {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 20px;
      }
      
      .test-content {
        font-size: 14px;
        padding: 8px;
      }
      
      .submission-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .submit-button,
      .save-button {
        width: 100%;
        margin-right: 0;
        padding: 12px 15px;
        font-size: 16px;
      }
    }
    
    /* Extra small mobile devices */
    @media screen and (max-width: 480px) {
      .modal {
        padding: 10px;
      }
      
      .modal-content {
        width: 98%;
        padding: 18px;
      }
      
      .modal-content h3 {
        font-size: 16px;
      }
      
      .modal-content p {
        font-size: 14px;
      }
      
      .modal-confirm,
      .modal-cancel {
        padding: 12px 16px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="{{ url_for('student_dashboard') }}">Dashboard</a></li>
        <li><a href="{{ url_for('video_lectures') }}">Video Lectures</a></li>
        <li><a href="{{ url_for('student_tests') }}">Tests</a></li>
        <li><a href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>{{ test.title }}</h1>

    {% if test.is_timed %}
    <p>Time Remaining: <span id="time-remaining">--:--:--</span></p>
    {% endif %}

    <section>
      <h2>Test Instructions</h2>
      <div class="card">
        <p><strong>Description:</strong> {{ test.description }}</p>
        <p><strong>Type:</strong> {{ 'Timed' if test.is_timed else 'Untimed' }}</p>
        {% if test.is_timed %}
        <p><strong>Time Limit:</strong> {{ test.time_limit }} minutes</p>
        {% endif %}
        <ul>
          <li>Read all questions carefully before answering.</li>
          <li>Type or speak your answers in the text area provided below.</li>
          {% if test.is_timed %}
          <li>The test will automatically submit when the time runs out.</li>
          <li>Do not leave or refresh the page during the test.</li>
          <li>Your work is automatically saved every 30 seconds.</li>
          {% endif %}
        </ul>
      </div>
    </section>

    <section>
      <h2>Test Questions</h2>
      <div class="card">
        {% if test_content %}
        <div class="test-content">{{ test_content | safe }}</div>
        {% else %}
        <p>No test content available. Please contact your instructor.</p>
        {% endif %}
      </div>
    </section>

    <section>
      <h2>Your Response</h2>
      <div class="card">
        <form id="testForm" method="POST" action="{{ url_for('submit_test', assignment_id=assignment.id) }}">
          <label for="content">Your Answer:</label><br>
          <textarea name="response_content" id="content" rows="10" cols="100">{{ response.content if response and response.content else '' }}</textarea>
          
          <div class="mic-container">
            <button type="button" id="micButton" class="mic-button">üéôÔ∏è Start Recording</button>
            <span id="micStatus" class="mic-status"></span>
          </div>
          
          <div class="submission-controls">
            <button type="button" id="submitButton" class="submit-button">Submit Test</button>
            <button type="button" id="saveButton" class="save-button">Save and Exit</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Enhanced confirm submission modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>Confirm Test Submission</h3>
      <p>Are you sure you want to submit your test? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="confirmSubmit" class="modal-confirm">Yes, Submit Test</button>
        <button id="cancelSubmit" class="modal-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Timer script for timed tests
    {% if test.is_timed and time_remaining %}
    let timeRemaining = {{ time_remaining }};
    const timeDisplay = document.getElementById('time-remaining');
    function updateTimer() {
      if (timeRemaining <= 0) {
        document.getElementById('testForm').submit();
        return;
      }
      let hours = Math.floor(timeRemaining / 3600);
      let minutes = Math.floor((timeRemaining % 3600) / 60);
      let seconds = timeRemaining % 60;
      timeDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      timeRemaining--;
    }
    setInterval(updateTimer, 1000);
    {% endif %}

    // Autosave script
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('content');
      let lastContent = textarea.value;
      setInterval(function() {
        if (textarea.value !== lastContent) {
          lastContent = textarea.value;
          fetch('{{ url_for('submit_test', assignment_id=assignment.id) }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `response_content=${encodeURIComponent(textarea.value)}&autosave=true`
          }).then(response => response.json()).then(data => {
            console.log(data.message);
          });
        }
      }, 30000);
    });

    // Speech-to-text script
    const micButton = document.getElementById('micButton');
    const answerTextarea = document.getElementById('content');
    const micStatus = document.getElementById('micStatus');

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US'; // Adjust as needed (e.g., 'hi-IN' for Hindi)
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onresult = function(event) {
        if (event.results.length > 0) {
          const transcript = event.results[0][0].transcript;
          answerTextarea.value = answerTextarea.value + (answerTextarea.value ? ' ' : '') + transcript;
          micStatus.textContent = 'Transcription added';
        }
      };

      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        micButton.textContent = 'üéôÔ∏è Start Recording';
        micButton.classList.remove('recording');
        micStatus.textContent = 'Error: ' + event.error;
      };

      recognition.onend = function() {
        micButton.textContent = 'üéôÔ∏è Start Recording';
        micButton.classList.remove('recording');
        micStatus.textContent = '';
      };

      micButton.onclick = function() {
        if (!micButton.classList.contains('recording')) {
          try {
            recognition.start();
            micButton.textContent = 'üéôÔ∏è Stop Recording';
            micButton.classList.add('recording');
            micStatus.textContent = 'Recording...';
          } catch (e) {
            micStatus.textContent = 'Error starting mic: ' + e.message;
          }
        } else {
          recognition.stop();
        }
      };

      // Log browser support
      micStatus.textContent = 'Speech recognition supported';
    } else {
      micButton.disabled = true;
      micButton.textContent = 'üéôÔ∏è Mic Not Supported';
      micStatus.textContent = 'Speech recognition not supported in this browser';
    }
    
    // Enhanced confirmation modal setup
    const modal = document.getElementById('confirmModal');
    const submitBtn = document.getElementById('submitButton');
    const saveBtn = document.getElementById('saveButton');
    const confirmBtn = document.getElementById('confirmSubmit');
    const cancelBtn = document.getElementById('cancelSubmit');
    const form = document.getElementById('testForm');
    
    submitBtn.onclick = function() {
      modal.style.display = "block";
      // Prevent body scroll on mobile when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      modal.style.display = "none";
      // Restore body scroll
      document.body.style.overflow = 'auto';
    }
    
    cancelBtn.onclick = closeModal;
    
    // Close modal if clicked outside (but not on mobile to prevent accidental closes)
    window.onclick = function(event) {
      if (event.target == modal && window.innerWidth > 768) {
        closeModal();
      }
    }
    
    // Handle escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && modal.style.display === 'block') {
        closeModal();
      }
    });
    
    confirmBtn.onclick = function() {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'submit_button';
      input.value = 'Submit Test';
      form.appendChild(input);
      form.submit();
    }
    
    saveBtn.onclick = function() {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'submit_button';
      input.value = 'Save and Exit';
      form.appendChild(input);
      form.submit();
    }
  </script>
</body>
</html>